<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   xmlns:buttons="com.anotherflexdev.ui.buttons.*"
					   xmlns:components="components.*"
					   xmlns:renders="renders.*" currentState="dashboard_productos"
					   preinitialize="preinitializeHandler(event)" skinClass="skins.skinProductos">
	<s:states>
		<s:State name="catalogo_productos"/>
		<s:State name="dashboard_productos"/>
	</s:states>
	
	<fx:Style source="Styles/Main.css"/>
	
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		@namespace buttons "com.anotherflexdev.ui.buttons.*";
		@namespace components "components.*";
		
		/*Setup callout styles*/
		components|SparkCallout {
			backgroundColor:		#FFFFFF;
			borderColor:			#f29c2e;
			borderThickness:		3;
		}
	</fx:Style>
	<fx:Declarations>
		<mx:HTTPService id="service" fault="errorGeneral(event)" result="onJSONLoad(event)"
						resultFormat="text"
						url="http://localhost/Ventas/amfphp/services/getAllProducts.php"
						useProxy="false"/>
		
		
		<mx:RemoteObject id="MiObjetoRemotoProducto" destination="amfphp" showBusyCursor="true"
						 source="producto"> 
			<s:method fault="errorGeneral(event)" name="callStoreProcedure"
					  result="resultCallStoreProcedure(event)"/>
		</mx:RemoteObject>
		
		<s:Callout id="defaultCallout" width="230" height="380"
				   mouseDown="defaultCallout_mouseDownHandler(event)"
				   mouseDownOutside="onMouseDownOutside(event)" verticalPosition="after">
			<s:layout>
				<s:VerticalLayout/>
			</s:layout> 
			<renders:renderCatalogoProductos includeIn="catalogo_productos"
											 click="currentState='dashboard_productos'"/>
			<renders:renderAdministrarProductos includeIn="dashboard_productos"
												click="currentState='catalogo_productos'"/>
			<renders:renderSoporte/>
			<renders:renderConfiguracion/>
			<renders:renderCerrarSession/>
		</s:Callout>
			
		<components:SparkCallout/>
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[		
			import clases.Cleanner;
			import clases.GlobalStatic;
			import clases.Productos;
			import clases.Utileria;
			
			import com.adobe.serialization.json.JSON;
			import com.anotherflexdev.ui.AlertError;
			import com.anotherflexdev.ui.AlertInfo;
			
			import mx.collections.ArrayCollection;
			import mx.collections.IList;
			import mx.controls.Alert;
			import mx.events.FlexEvent;
			import mx.events.FlexMouseEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			[Bindable] internal var dp:ArrayCollection = new ArrayCollection();
			[Bindable] internal var producto:clases.Productos;
			[Bindable] public var arrayMarcas:ArrayCollection;
			[Bindable] public var arrayOferta:ArrayCollection = new ArrayCollection([{value:"SI"},{value:"NO"}]);
			[Bindable] public var arrayTipoVenta:ArrayCollection = new ArrayCollection([{value:"Pieza(s)"},{value:"A granel Kg/gr"}]);
			internal var arrayOriginal:ArrayCollection;
			
			internal function resultCallStoreProcedure(exito:ResultEvent):void
			{
				removeEventListener(ResultEvent.RESULT, resultCallStoreProcedure);
				PopUpManager.removePopUp(GlobalStatic.utility.progress);
				switch(exito.result.response)
				{
					case "0":
						service.send();
						AlertInfo.show("La información se ha guardo de forma exitosa", 'Atención');
						break;
					case "1":
					case "2":
						AlertError.show("Ocurrio un error al guardar la información.", "Error");
						break;
				}
				
			}
			
			internal function onJSONLoad(event:ResultEvent):void
			{
				removeEventListener(ResultEvent.RESULT, onJSONLoad);
				dp.removeAll();
				dp = encapsulado((com.adobe.serialization.json.JSON.decode(String(event.result))));
				arrayMarcas = new ArrayCollection(Utileria.group(dp));
				arrayOriginal = Utileria.clonar(dp);
				System.gc();
			}
			
			internal function preinitializeHandler(event:FlexEvent):void
			{
				removeEventListener(FlexEvent.PREINITIALIZE,preinitializeHandler);
				maximize();
				service.send();
			}
			
			internal function errorGeneral(error:FaultEvent):void
			{
				removeEventListener(FaultEvent.FAULT, errorGeneral);
				Alert.show(error.fault.faultString, "Ocurrio un error");
			}
			
			internal function encapsulado(collection:*):ArrayCollection{
				
				var array:ArrayCollection = new ArrayCollection();
				
				for each(var item:Object in collection)
				{
					producto = new clases.Productos(item);
					array.addItem(producto);
				}
				return array;
			}
			
			internal var lista:IList = new ArrayList();
			internal var queryString:String;
			internal function btnGuardar_clickHandler():void
			{
				var foundObject:Array = new Array(), index:uint = 0;
				GlobalStatic.utility.showLoading("Espere un momento mientras se guarda la información"); 
				for each(var item:Object in datagrid_productos.dataProvider)
				{
					foundObject = GlobalStatic.utility.findMatchesByIDReturnArray(item.id_producto, arrayOriginal,"id_producto");
					for each(var originalItem:Object in foundObject)
					{							
						originalItem.nom_producto != item.nom_producto ? lista.addItem(" nom_producto = \'" + item.nom_producto + "\'") : "";
						
						if(lista.length > 0)
						{
							queryString = "UPDATE " + GlobalStatic.DataBaseName + ".producto SET";
							index = lista.length - 1;
							for each(var obj:Object in lista.toArray())
							index-- == 0 ? queryString += obj : queryString += obj + " ,";
							
							queryString += " WHERE id_producto = " + item.id_producto;
							GlobalStatic.utility.queryMasivo(queryString);
							lista = null;
							queryString = null;
						}
						break;	
					}
				}
				if(GlobalStatic.utility.listaQuerys.length > 0)
					contruirQuery();
				else
					trace("error");
					
			}
			
			internal function contruirQuery():void
			{
				var superQuery:String = "";
				var index:uint = GlobalStatic.utility.listaQuerys.length - 1;
				for each(var query:Object in GlobalStatic.utility.listaQuerys.toArray())
				index-- == 0 ? superQuery += query : superQuery += query + "|()|";
				GlobalStatic.utility.listaQuerys.removeAll();//AHORA REMOVEMOS TODO LO QUE HAY EN LA LISTA PARA OCUPARLA LA PROXIMA VEZ.
				trace("call " + GlobalStatic.DataBaseName + ".Procedure_SqlTable(\"" + superQuery +"\")");
				MiObjetoRemotoProducto.callStoreProcedure.send(superQuery);
			}
			
			internal var palabra:String;
			
			internal function doSearch():void {
				palabra = txtBuscar.text.toLowerCase();
				dp.filterFunction = filterMyArrayCollection;
				dp.refresh();
			}
			
			internal function filterMyArrayCollection(item:Object):Boolean 
			{				
				return ((item.nom_producto.toLowerCase().indexOf(palabra) != -1) || (item.marca.toLowerCase().indexOf(palabra) != -1) || (item.descripcion.toLowerCase().indexOf(palabra) != -1))
			}
			
			internal function changeBusqueda():void{
				if(txtBuscar.text.length == 0){
					palabra = '';
					dp.filterFunction = filterMyArrayCollection;
					dp.refresh();
				}
			}
			
			internal function onShowDefaultCalloutClick():void {
				defaultCallout.open(btnMenu);
			}
			
			internal function onMouseDownOutside(event:FlexMouseEvent):void {
				event.target.close();
			}
						
			internal function defaultCallout_mouseDownHandler(event:MouseEvent):void
			{
				defaultCallout.close();
			}
			
		]]>
		
	</fx:Script>
	
	<s:Scroller id="scroll" includeIn="catalogo_productos,dashboard_productos" width="100%"
				height="100%">
		<s:Group id="Contenedor" width="100%" height="100%">
			<s:BorderContainer id="border_header" x="0" y="0" width="100%" height="50"
							   borderVisible="false">
				<s:backgroundFill>
					<s:LinearGradient rotation="90">
						
						<s:GradientEntry color="#f29c2e"/>
						<s:GradientEntry color="#f9a73c"/>
					</s:LinearGradient>
				</s:backgroundFill> 
				<s:TextInput id="txtBuscar" includeIn="dashboard_productos,catalogo_productos" y="12"
							 left="60" width="400" borderColor="#FFA800" borderVisible="true"
							 change="changeBusqueda()" chromeColor="#FFA800" enter="doSearch();"
							 focusColor="#FF8A00" fontSize="16" fontStyle="normal" maxChars="30"
							 prompt="Buscar"/>
				<s:Image id="btn_buscar" includeIn="dashboard_productos,catalogo_productos" x="440"
						 width="50" height="50" buttonMode="true" click="doSearch();"
						 scaleMode="letterbox" smooth="true" smoothingQuality="high"
						 source="img/btnSearch.png" verticalCenter="-1"/>
				<s:Image id="btnMenu" includeIn="dashboard_productos,catalogo_productos" x="25"
						 width="24" height="24" buttonMode="true"
						 click="onShowDefaultCalloutClick()" smooth="true" smoothingQuality="high"
						 source="img/ModIco.png" verticalCenter="-1"/>
				<s:HGroup x="550" y="5" height="40">
					<renders:renderAdd id="btnNuevo" includeIn="catalogo_productos"
									   click="AlertError.show('Ocurrio un error al guardar la información.')"/>
					<renders:renderDelete id="btnEliminar" includeIn="catalogo_productos"/>
					<renders:renderSave id="btnGuardar" includeIn="catalogo_productos"
										click="btnGuardar_clickHandler()"/>
					<renders:renderPrint id="btnImprimir" includeIn="catalogo_productos"
										 click="AlertInfo.show('Ocurrio un error al guardar la información.')"/>
					<renders:renderHelp id="btnAyuda" includeIn="catalogo_productos"
										click="AlertInfo.show('Ocurrio un error al guardar la información.')"/>
				</s:HGroup>
			</s:BorderContainer>
			
			<s:List id="list" includeIn="dashboard_productos" left="20" right="0" top="50" bottom="0"
					borderVisible="false" contentBackgroundAlpha="0.5" dataProvider="{dp}"
					focusColor="#F48D08" itemRenderer="skins.itemRenderProducto"
					rollOverColor="#D1D1D1" selectionColor="#ADADAD">
				<s:layout>
					<s:TileLayout horizontalGap="10" verticalGap="10"/>
				</s:layout>
			</s:List>
			<s:DataGrid id="datagrid_productos" includeIn="catalogo_productos" x="0" y="50"
						width="100%" height="100%" dataProvider="{dp}" editable="true">
				<s:columns>
					<s:ArrayList>
						<s:GridColumn dataField="nom_producto" headerText="Nombre"></s:GridColumn>
						<s:GridColumn dataField="marca" editable="false" headerText="Marca"
									  itemRenderer="renders.itemRenderMarcas"></s:GridColumn>
						<s:GridColumn dataField="descripcion" headerText="Descripción"></s:GridColumn>
						
						<s:GridColumn dataField="cantidad" headerText="Cantidad"></s:GridColumn>
						<s:GridColumn dataField="precio" headerText="Precio"></s:GridColumn>
						<s:GridColumn dataField="precio_compra" headerText="Precio compra"></s:GridColumn>
						
						<s:GridColumn editable="false" headerText="Foto" itemRenderer="itemRenderImg"></s:GridColumn>
						
						<s:GridColumn dataField="fecha_entrada" editable="false"
									  headerText="Fecha Entrada" itemRenderer="renderFechaEntrada"></s:GridColumn>
						<s:GridColumn dataField="tipoVenta" editable="false" headerText="Tipo Venta"
									  itemRenderer="renders.itemRenderTipoVenta"></s:GridColumn>
						
						<s:GridColumn dataField="ofertas_Especiales" editable="false"
									  headerText="Oferta"
									  itemRenderer="renders.itemRenderOfertaEspecial"></s:GridColumn>
						
						
					</s:ArrayList>
				</s:columns>
			</s:DataGrid>
		</s:Group>
	</s:Scroller>	
</s:WindowedApplication>
